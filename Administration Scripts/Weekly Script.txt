# Retrieve accounts  disabled since Lastweek with groups still on the account, find groups and remove them

# Get current date
$grabDate = ((Get-Date).AddDays(-7)).Date

# Grab disabled users from past 7 days
$dusers = Get-ADUser -filter {enabled -eq $false -and whenChanged -ge $grabDate} -properties * | where { ($_.memberof | measure).count -gt 1} | select samaccountname

# Put disabled users in TXT file
$dusers | Out-File C:\tmp\ad\duserswithgroups.txt

# Grab disabled users TXT File to remove groups
$users = Get-Content C:\tmp\ad\duserswithgroups.txt
Foreach ($user in $users){

    # Search for groups on user account and put them in TXT file
    (Get-AdUser -Identity $user -Properties MemberOf | select-object MemberOf).MemberOf | Out-File C:\tmp\ad\groupstoremove.txt

    # Use Group list and loop through to try and remove them
    $groups = Get-Content C:\tmp\ad\groupstoremove.txt
    foreach ($group in $groups) {
        Try{
        Remove-ADPrincipalGroupMembership $user -member $group  -confirm:$false -ErrorAction Stop
        Write-Host "removing $($user) from $group" -ForegroundColor green
        }
        Catch
        {write-warning "$_ Error removing user $($User) from $group"}
        }
    }
}